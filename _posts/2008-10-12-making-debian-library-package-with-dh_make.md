---
id: 217
title: Making Debian library package with dh_make
date: 2008-10-12T23:50:04+00:00
author: tomasz
layout: post
guid: http://myitcorner.com/?p=217
excerpt_separator: <!--more-->
permalink: /2008/10/12/making-debian-library-package-with-dh_make/
categories:
  - Blog Entry
tags:
  - ANSI C
  - autotools
  - debian
  - gnu
  - library
  - package
---
This post is a short introduction to building _*.deb_ packages using _dh_make_ & _dpkg_buildpackage_ tools.

Let us assume that we want to make a Debian package for a simple library. We are going to create two _*.deb_ files, due to the fact that in Debian-based operating systems, libraries are usually distributed in one of the two forms:

  * **dev package** &#8211; containing both library binaries and header files for programmers. Used mainly by the developers.
  * **standard package** &#8211; storing only the library binaries

<!--more-->

Having that in mind, we should start our work from downloading necessary utilities:
  
```
apt-get install dpkg-dev dh-make  debhelper devscripts pbuilder fakeroot
```

Next step is to set a proper name for the directory containing the source code of the library.
  
It should have the following pattern: _<package>-<version>_ ( ex. mylib-0.1.0 )
  
Inside that directory we execute a command generating files describing the content of the package:

```
dh_make -l<br />
```
  
where &#8220;l&#8221; stands for library

We can notice that a new directory &#8220;debian&#8221; was created. It contains several files, the most important are described below:

  * _changelog_ &#8211; Changelog for the package from which a number of the latest version is taken
  * _control_ &#8211; File containing package description and its dependencies
  * _rules_ &#8211; Script responsible for generating package (similar to make)
  * _mylib1.install_ &#8211; List of directories containing files which should be copied to the package (normal package)
  * _mylib-dev.install_ &#8211; Similar as mylib1.install but related to development package 

Just to make it look better, let&#8217;s rename all &#8220;mylib1\*&#8221; files into &#8220;mylib\*&#8221; and then delete unnecessary \*.EX and \*.ex files. (these files are used in more complex packages, for example involving _rc.init_ script modifications)

Exemplary content of the mentioned files is presented below:

**debian/changelog**

```
mylib (0.1.0-1) unstable; urgency=low

* Initial release

-- TG <myemail@x.com>  Fri, 05 Sep 2008 17:40:45
```

**debian/control**

```
Source: mylib
Priority: extra
Maintainer: TG <myemail@x.com>
Build-Depends: debhelper (>= 5)
Standards-Version: 3.7.2
Section: libs

Package: mylib-dev
Section: libdevel
Architecture: any
Depends: mylib (= ${Source-Version})
Description:  myITcorner.com Sample Library  (dev)
Development files.

Package: mylib
Section: libs
Architecture: any
Depends: libglib2.0-0 (>= 2.6), openssl (>= 0.9)
Description:  myITcorner.com Sample Library.
Binary package
```

**mylib.install**
  
Copy all the libraries from usr/local/lib 

```
usr/local/lib/lib*.so.*
```

**mylib.install**
  
Copy all the libraries (also dev files) and C headers

```
usr/local/include/*
usr/local/lib/lib*.a
usr/local/lib/lib*.so
usr/local/lib/pkgconfig/*
usr/local/lib/*.la
usr/local/lib/pkgconfig/*
```

**debian/rules**
  
Content of _debian/rules_ script is more complex and in most of the situations we can base our package on the file generated by _dh_make_ utility. However, some minor modifications presented below should be introduced:

```
...
#Configure and compile library from the
#source code and install it into temporary location
install: build
	dh_testdir
	dh_testroot
	dh_clean -k 
	dh_installdirs

	# Add here commands to install
        # the package into debian/tmp
	$(MAKE) DESTDIR=$(CURDIR)/debian/tmp install

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs ChangeLog
	dh_installdocs
	dh_installexamples
	dh_install --sourcedir debian/tmp
```

It&#8217;s worth mentioning that a structure of the above file is similar to _Makefile_ script. There are some tasks and their dependencies. For example in _install_ task a library is compiled and then installed into _debian/tmp_ directory. Later in _binary-arch_, a Debian package is generated from the compiled data taken from _debian/tmp_ directory.

**Building the package**

Package description and configuration files are ready. So how to make a *.deb files? For that purpose we can use the following command:
```
dpkg-buildpackage -us -uc -rfakeroot
```
But let's make it simpler. Why not to add an entry in a _Makefile_, just to have everything in one place? 
Assuming that we are using Autotools, here is the most interesting part of Makefile.am.

**Makefile.am**

```
pkg-deb: dist
	- rm -rf  $(TMP_DIR)
	mkdir -p $(TMP_DIR)
	mv $(PACKAGE)-$(VERSION).tar.gz $(TMP_DIR)/

	tar --directory $(TMP_DIR)/ \
         -xf $(TMP_DIR)/$(PACKAGE)-$(VERSION).tar.gz

	cd $(TMP_DIR)/$(PACKAGE)-$(VERSION)/; \
                ./configure; \
                dpkg-buildpackage -us -uc -rfakeroot; \
                mv ../*.deb $(PWD)/pkg/

	rm -rf $(TMP_DIR);
```

In such a way a new task pkg-deb was defined. It executes another task called _dist_, which makes a tarball of the library source code. Later _dpkg-buildpackage_ is called and just to clean everything up, some files are either removed or renamed.

It is important not to forget about including _debian_ directory in the tarball generated with _dist_ task. It can be done by adding the following line somewhere at the top of the _Makefile.am_:
  
```
EXTRA_DIST = <some_pkg_config_file.pc; other_files> debian
```

By the way TMP_DIR stores a location of the directory for the library installation files. In my case I assumed that
  
```
TMP_DIR = tmp<br />
```

Now it&#8217;s enough to invoke:

```
make pkg-deb<br />
```

Debian packages should be created inside _pkg_ directory.

**References:**
  
[Debian New Maintainers&#8217; Guide](http://www.debian.org/doc/manuals/maint-guide/ch-start.en.html "Debian New Maintainers Guide") 
  
[Andy Balaam&#8217;s Blog](http://www.artificialworlds.net/blog/2007/02/22/creating-deb-and-rpm-packages/ "Andy Balaam Blog")